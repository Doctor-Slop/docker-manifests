#fastcgi_cache_path  /tmp/nginx/mediawiki    levels=1:2  keys_zone=mediawiki:15m;

server {
    listen 80;
    listen [::]:80;
    server_name ~^www\.gobblerpedia.(org|oss)$;
    #access_log /var/log/nginx/gobblerpedia.log;
    access_log /var/log/nginx;
    location /.well-known/acme-challenge {
        root /var/lib/letsencrypt/public_html;
        default_type text/plain;
    }
    location / {
        return 301 https://gobblerpedia.org$request_uri;
    }
    #rewrite ^ https://gobblerpedia.org$request_uri permanent;
}

server {
    listen 443;
    listen [::]:443;
    server_name ~^www\.gobblerpedia.(org|oss)$;
    #access_log /var/log/nginx/gobblerpedia.log;
    access_log /var/log/nginx;
    rewrite ^ https://gobblerpedia.org$request_uri permanent;
    
    # TLS {{{
    ssl  on;
    ssl_certificate /etc/letsencrypt/live/gobblerpedia.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/gobblerpedia.org/privkey.pem;
    ssl_dhparam /etc/nginx/dhparam.pem;

    ssl_session_timeout  5m;
    ssl_session_cache   shared:SSL:10m;

    ssl_protocols TLSv1.1 TLSv1.2;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:!DSS';
    ssl_prefer_server_ciphers   on;

    # HTTP Strict Transport Security
    #add_header Strict-Transport-Security max-age=15552000;
    # }}}
}

server {
    listen 80;
    listen [::]:80;
    server_name  ~^gobblerpedia.(org|oss)$;
    #access_log /var/log/nginx/gobblerpedia.log;
    access_log /var/log/nginx;
    #rewrite ^ https://$host$request_uri permanent;
    location /.well-known/acme-challenge {
        root /var/lib/letsencrypt/public_html;
        default_type text/plain;
    }
    location / {
        return 301 https://gobblerpedia.org$request_uri;
    }
    #rewrite ^ https://gobblerpedia.org$request_uri permanent;

}

server {
    listen 443;
    listen [::]:443;
    server_name  ~^gobblerpedia.(org|oss)$;
    server_name_in_redirect off;

    # TLS {{{
    ssl  on;
    ssl_certificate /etc/letsencrypt/live/gobblerpedia.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/gobblerpedia.org/privkey.pem;
    ssl_dhparam /etc/nginx/dhparam.pem;

    ssl_session_timeout  5m;
    ssl_session_cache   shared:SSL:10m;

    ssl_protocols TLSv1.1 TLSv1.2;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:!DSS';
    ssl_prefer_server_ciphers   on;

    # HTTP Strict Transport Security
    #add_header Strict-Transport-Security max-age=15552000;

        # }}}

    client_max_body_size 5M;
    #access_log /var/log/nginx/gobblerpedia.log;
    access_log /var/log/nginx;
    root /srv/http/gobblerpedia.org;
    include /etc/nginx/antispam.conf;

    # PHP-FPM {{{
    location ~ \.php$ {
        include /etc/nginx/php-fpm.conf;
        fastcgi_param  HTTPS on;

#        fastcgi_cache       mediawiki;
#        fastcgi_cache_key   gobblerpedia$request_uri;
#        fastcgi_no_cache    $cookie_mediawiki_session;
    }
    # }}}

    # Cache static content {{{
    location /w/images {
        alias /srv/http/gobblerpedia.org/w/images/gobblerpedia.org;
        expires 30d;
    }

    location /w/skins {
        expires  30d;
    }
    # }}}

    # Rewrite MediaWiki links to point to PHP script
    location ~ ^/wiki/ {
        rewrite ^/([^?]*)(?:\?(.*))? /w/index.php?title=$1&$2 last;
    }

    # Deny access to generated cache
    location /w/cache {
        deny  all;
    }

    # Redirect to main page
    rewrite ^/$ /w/index.php last;
}
