server {
    listen     80;
    listen [::]:80;
    server_name vtluug.org www.vtluug.org;

    location /.well-known/acme-challenge {
        root /var/lib/letsencrypt/public_html;
        default_type text/plain;
    }
    location / {
        return 301 https://vtluug.org$request_uri;
        #return 301 https://vtluug.org/;
    }
}

server {
    listen 127.0.0.1:8002;
    location / {
        #proxy_set_header Host vtluug.org;
        proxy_set_header Host vtluug.github.io;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header X-Real-IP   $remote_addr;
  
        proxy_buffering off;
        proxy_cache off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        chunked_transfer_encoding off;
  
        #proxy_ssl_trusted_certificate /etc/ssl/certs/upstream-ca.pem;
        #proxy_ssl_verify on;

        #proxy_pass https://10.99.0.2;
	proxy_pass https://vtluug.github.io;
        client_max_body_size 10M;
    }
}


server {
    listen     80;
    listen [::]:80;
    server_name wiki.vtluug.org;

    location /.well-known/acme-challenge {
        root /var/lib/letsencrypt/public_html;
        default_type text/plain;
    }
    #rewrite http://wiki.vtluug.org/ https://vtluug.org/wiki/Main_page permanent;
    #rewrite ^ https://vtluug.org/ permanent;
    #location / {
#	return 301 https://vtluug.org/wiki/Main_page;
    #}
    rewrite ^/$ https://vtluug.org/wiki/Main_page permanent;
    rewrite ^/wiki/(.*)$ https://vtluug.org/wiki/$1 permanent;
    rewrite ^/w/(.*)$ https://vtluug.org/wiki/$1 permanent;
    #rewrite ^ https://vtluug.org$request_uri permanent;
}

server {
    listen    443    ssl;
    listen [::]:443 ssl;
    server_name www.vtluug.org;

    ssl_certificate /etc/letsencrypt/live/vtluug.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/vtluug.org/privkey.pem;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:!DSS';

    ssl_protocols TLSv1.1 TLSv1.2;

    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 5m;

    ssl_prefer_server_ciphers   on;
    ssl_stapling on;
    ssl_dhparam /etc/nginx/dhparam.pem;

    #rewrite ^ https://vtluug.org/ permanent;
    return 301 https://vtluug.org$request_uri;
}

server {
    listen    443    ssl;
    listen [::]:443 ssl;
    server_name wiki.vtluug.org;

    ssl_certificate /etc/letsencrypt/live/vtluug.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/vtluug.org/privkey.pem;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:!DSS';

    ssl_protocols TLSv1.1 TLSv1.2;

    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 5m;

    ssl_prefer_server_ciphers   on;
    ssl_stapling on;
    ssl_dhparam /etc/nginx/dhparam.pem;
    
#    location / {
#	return 301 https://vtluug.org/wiki/Main_page;
#    }
#    rewrite ^ https://vtluug.org$request_uri permanent;
#    rewrite https://wiki.vtluug.org/ https://vtluug.org/wiki/Main_page permanent;
#    rewrite ^ https://vtluug.org$request_uri permanent;
#    #rewrite ^ https://vtluug.org/ permanent;
    rewrite ^/$ https://vtluug.org/wiki/Main_page permanent;
    rewrite ^/wiki/(.*)$ https://vtluug.org/wiki/$1 permanent;
    rewrite ^/w/(.*)$ https://vtluug.org/wiki/$1 permanent;
}

server {
    listen    443    ssl;
    listen [::]:443    ssl;
    server_name vtluug.org;
    
    ssl_certificate /etc/letsencrypt/live/vtluug.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/vtluug.org/privkey.pem;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:!DSS';

    ssl_protocols TLSv1.1 TLSv1.2;

    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 5m;

    ssl_prefer_server_ciphers   on;
    ssl_stapling on;
    ssl_dhparam /etc/nginx/dhparam.pem;

    gzip off;    

    #rewrite ^/wiki/(.*) https://vtluug.org/ permanent;

    root /srv/http/vtluug.org;
    index index.html index.htm;

    location / {
        #proxy_set_header Host $host;
        proxy_set_header Host vtluug.github.io;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_set_header X-Real-IP    $remote_addr;

        proxy_buffering off;
        proxy_cache off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        chunked_transfer_encoding off;

        #proxy_ssl_trusted_certificate /etc/ssl/certs/upstream-ca.pem;
        #proxy_ssl_verify on;

        #proxy_pass https://10.99.0.2;
	proxy_pass https://vtluug.github.io;
        client_max_body_size 10M;
    }

#    location ~ /bash(.*) {
#	root /var/lib/letsencrypt/public_html;
#   }

    location /files {
        #this ensures people don't know if a file doesn't exist or they're
        #blacklisted
        if (!-e $request_filename) {
            return 403;
        }
        autoindex on;
        alias /srv/http/vtluug.org/files/;
    }
    location /files/2013/hamexam {
        # we got a c&d
        alias /srv/http/vtluug.org/files/2013/hamexam/;
        autoindex on;
        allow 127.0.0.1;
        allow ::1;
        allow 10.0.0.0/8;
        allow 198.82.0.0/16;
        allow 128.173.0.0/16;
        allow 2607:b400::/32;
        allow 2001:468:c80::/48;
        deny all;
    }
    location ~ ^/users/~(.+?)(/.*)?$ {
        alias /home/$1/public_html$2;
        index index.html index.htm;
        autoindex on;
    }

    location ~ \.php$ {
        include /etc/nginx/php-fpm.conf;
        fastcgi_param  HTTPS on;
    }

    rewrite ^/wiki$ /w/index.php last;

    location ~ ^/w/images/(.*)$ {
        alias /srv/http/vtluug.org/w/images/vtluug.org/$1;
        expires 30d;
    }

    location ~ ^/w/skins {
        expires  30d;
    }

    location ~ ^/wiki/ {
        rewrite ^/([^?]*)(?:\?(.*))? /w/index.php?title=$1&$2 last;
    }

    # Deny access to generated cache
    location /w/cache {
        deny  all;
    }
}

# server {
#     listen     80;
#     listen [::]:80;
#     server_name gobblerpedia.org www.gobblerpedia.org;
# 
#     location /.well-known/acme-challenge {
#         root /var/lib/letsencrypt/public_html;
#         default_type text/plain;
#     }
#     location / {
#         #return 301 https://gobblerpedia.org$request_uri;
#         return 301 https://gobblerpedia.org/;
#     }
# }
# 
# server {
#     listen    443    ssl;
#     listen [::]:443 ssl;
#     server_name www.gobblerpedia.org;
# 
#     ssl_certificate /etc/letsencrypt/live/gobblerpedia.org/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/gobblerpedia.org/privkey.pem;
#     ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:!DSS';
# 
#     ssl_protocols TLSv1.1 TLSv1.2;
# 
#     ssl_session_cache   shared:SSL:10m;
#     ssl_session_timeout 5m;
# 
#     ssl_prefer_server_ciphers   on;
#     ssl_stapling on;
#     ssl_dhparam /etc/nginx/dhparam.pem;
# 
#     location / {
#         #return 301 https://gobblerpedia.org$request_uri;
#         return 301 https://gobblerpedia.org/;
#     }
# }
# 
# server {
#     listen    443    ssl;
#     listen [::]:443    ssl;
#     server_name gobblerpedia.org;
#     
#     ssl_certificate /etc/letsencrypt/live/gobblerpedia.org/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/gobblerpedia.org/privkey.pem;
#     ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:!DSS';
# 
#     ssl_protocols TLSv1.1 TLSv1.2;
# 
#     ssl_session_cache   shared:SSL:10m;
#     ssl_session_timeout 5m;
# 
#     ssl_prefer_server_ciphers   on;
#     ssl_stapling on;
#     ssl_dhparam /etc/nginx/dhparam.pem;
# 
#     gzip off;    
# 
#   #  rewrite ^ https://vtluug.org/ permanent;
# 
#     location / {
#         #proxy_set_header Host $host;
#         proxy_set_header Host vtluug.github.io;
#         proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
#         proxy_set_header X-Real-IP    $remote_addr;
# 
#         proxy_buffering off;
#         proxy_cache off;
#         proxy_http_version 1.1;
#         proxy_set_header Connection "";
#         chunked_transfer_encoding off;
# 
#         #proxy_ssl_trusted_certificate /etc/ssl/certs/upstream-ca.pem;
#         #proxy_ssl_verify on;
# 
#         #proxy_pass https://10.99.0.2;
# 	proxy_pass https://vtluug.github.io;
#         client_max_body_size 10M;
#     }
# 
#     location ~ ^/wiki/ {
#         rewrite ^/([^?]*)(?:\?(.*))? /w/index.php?title=$1&$2 last;
#     }
# 
#     location ~ \.php$ {
#         include /etc/nginx/php-fpm.conf;
#         fastcgi_param  HTTPS on;
#     }
# 
# }
server {
    listen     80;
    listen [::]:80;
    server_name foodfor.vtluug.org;

    location /.well-known/acme-challenge {
        root /var/lib/letsencrypt/public_html;
        default_type text/plain;
    }
    location / {
        return 301 https://foodfor.vtluug.org$request_uri;
    }
}
server {
    listen    443    ssl;
    listen [::]:443 ssl;
    server_name foodfor.vtluug.org;

    ssl_certificate /etc/letsencrypt/live/foodfor.vtluug.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/foodfor.vtluug.org/privkey.pem;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:!DSS';

    ssl_protocols TLSv1.1 TLSv1.2;

    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 5m;

    ssl_prefer_server_ciphers   on;
    ssl_stapling on;
    ssl_dhparam /etc/nginx/dhparam.pem;

    root /srv/http/foodfor.vtluug.org;
    include /etc/nginx/antispam.conf;
    index index.html index.htm;

    location / {
        include uwsgi_params;
	uwsgi_pass unix:/srv/http/foodfor.vtluug.org/run/foodforus.socket;
    }
}
